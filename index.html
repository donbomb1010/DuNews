<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darshan Breaking News</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .hidden { display: none; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .btn { padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; min-width: 3rem; height: 3rem; }
        .btn-primary { background-color: #dc2626; color: white; }
        .btn-primary:hover { background-color: #b91c1c; }
        .btn-primary:disabled { background-color: #ef4444; cursor: not-allowed; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        input[type="text"], input[type="email"], input[type="password"], textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-top: 0.5rem; margin-bottom: 1rem; box-sizing: border-box; }
        input[type="file"] { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-top: 0.5rem; margin-bottom: 1rem; box-sizing: border-box; background-color: #f9fafb; cursor: pointer; }
        textarea { min-height: 120px; resize: vertical; }
        .message-box { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); padding: 20px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; text-align: center; width: 320px; max-width: 90%; }
        .message-box button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; margin: 0.5rem; font-weight: 600; }
        .news-media { width: 100%; height: auto; border-radius: 0.5rem; margin-bottom: 0.75rem; display: block; object-fit: cover; background-color: #e5e7eb; }
        /* Auth Container Styles */
        #auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .auth-card { width: 100%; max-width: 400px; }
        .auth-toggle { text-align: center; margin-top: 1rem; }
        .auth-toggle button { background: none; border: none; color: #dc2626; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Section (Login/Signup) -->
    <div id="auth-container">
        <div class="card auth-card">
            <!-- Login Form -->
            <form id="login-form">
                <h2 class="text-3xl font-bold text-center mb-6">Login</h2>
                <label for="login-email" class="block text-gray-700 font-medium">Email:</label>
                <input type="email" id="login-email" required>
                <label for="login-password" class="block text-gray-700 font-medium">Password:</label>
                <input type="password" id="login-password" required>
                <button type="submit" class="btn btn-primary w-full mt-4">Login</button>
                <div class="auth-toggle">
                    <p>Don't have an account? <button type="button" id="show-signup">Sign Up</button></p>
                </div>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-6">Create Account</h2>
                 <label for="signup-username" class="block text-gray-700 font-medium">Username:</label>
                <input type="text" id="signup-username" required>
                <label for="signup-email" class="block text-gray-700 font-medium">Email:</label>
                <input type="email" id="signup-email" required>
                <label for="signup-password" class="block text-gray-700 font-medium">Password:</label>
                <input type="password" id="signup-password" required>
                <button type="submit" class="btn btn-primary w-full mt-4">Create Account</button>
                <div class="auth-toggle">
                    <p>Already have an account? <button type="button" id="show-login">Login</button></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <header class="bg-red-600 text-white p-4 shadow-md sticky top-0 z-50">
            <div class="container flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold mb-2 md:mb-0">Darshan Breaking News</h1>
                <nav class="w-full md:w-auto mt-4 md:mt-0">
                    <ul class="flex space-x-2 sm:space-x-4 justify-center">
                        <li><button onclick="showSection('home-section')" class="btn btn-primary" title="Home"><i class="fas fa-home"></i></button></li>
                        <li><button onclick="showSection('add-news-section')" class="btn btn-primary" title="Add News"><i class="fas fa-plus-circle"></i></button></li>
                        <li><button onclick="showSection('profile-section')" class="btn btn-primary" title="My Profile"><i class="fas fa-user"></i></button></li>
                        <li><button id="logout-btn" class="btn btn-primary" title="Logout"><i class="fas fa-sign-out-alt"></i></button></li>
                    </ul>
                </nav>
            </div>
        </header>

        <main class="container mt-8 flex-grow">
            <!-- Home Section -->
            <section id="home-section">
                 <h2 class="text-2xl font-semibold mb-4">Latest News</h2>
                <div id="newsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- News items loaded here -->
                </div>
            </section>

            <!-- Add News Section -->
            <section id="add-news-section" class="card hidden">
                <h2 class="text-2xl font-semibold mb-4" id="addNewsSectionTitle">Publish New News</h2>
                <form id="addNewsForm">
                    <label for="newsTitle" class="block text-gray-700 font-medium">News Title:</label>
                    <input type="text" id="newsTitle" required>

                    <label for="newsContent" class="block text-gray-700 font-medium">Content:</label>
                    <textarea id="newsContent" required></textarea>
                    
                    <label for="newsMediaFile" class="block text-gray-700 font-medium">Upload Image or Video:</label>
                    <input type="file" id="newsMediaFile" accept="image/*,video/*">

                    <button type="submit" class="btn btn-primary mt-4" id="addNewsSubmitBtn"><i class="fas fa-paper-plane mr-2"></i>Publish News</button>
                    <button type="button" onclick="cancelEdit()" class="btn btn-secondary mt-4 ml-2 hidden" id="cancelEditBtn">Cancel</button>
                </form>
            </section>

            <!-- My Profile Section -->
            <section id="profile-section" class="card hidden">
                <h2 class="text-2xl font-semibold mb-4">My Profile</h2>
                 <p id="profile-email-display" class="text-center text-gray-500 mb-4"></p>
                 <form id="profileEditForm">
                    <label for="profileUsername" class="block text-gray-700 font-medium">Username:</label>
                    <input type="text" id="profileUsername" required>
                    <button type="submit" class="btn btn-primary mt-4"><i class="fas fa-save mr-2"></i>Update Profile</button>
                </form>
                <hr class="my-8">
                <h3 class="text-xl font-semibold mb-4">My Published News</h3>
                <div id="myNewsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- User's news loaded here -->
                </div>
            </section>

        </main>
        
        <footer class="bg-gray-800 text-white p-4 mt-8 text-center">
            <p>&copy; 2025 Darshan Breaking News. All rights reserved.</p>
        </footer>
    </div>
    
    <!-- Message Box HTML -->
    <div id="messageBox" class="message-box hidden">
        <p id="messageContent" class="text-lg"></p>
        <div id="messageButtons" class="flex justify-center mt-4 space-x-4"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, query, where, orderBy, doc, setDoc, updateDoc, deleteDoc, serverTimestamp, onSnapshot, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBP2wMWL1c6OqgLl6s6A8rZ2zKqrLjLyHo",
            authDomain: "dunews-8d3c9.firebaseapp.com",
            projectId: "dunews-8d3c9",
            storageBucket: "dunews-8d3c9.appspot.com",
            messagingSenderId: "453395637774",
            appId: "1:453395637774:web:76bcf43dc32397e05d3e5f"
        };

        const CLOUDINARY_UPLOAD_PRESET = 'NEWSIMAGE';
        const CLOUDINARY_CLOUD_NAME = 'dl6gzgu6i';

        // --- SERVICE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let editingNewsId = null;
        const usersCache = new Map();

        // --- AUTH & UI HANDLING ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                showSection('home-section');
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        // Event Listeners for Auth forms
        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignUp);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        document.getElementById('show-signup').addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', () => {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessageBox(`Error: ${error.message}`);
            }
        }
        
        async function handleSignUp(e) {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const username = document.getElementById('signup-username').value.trim();
            
            if (!username) {
                showMessageBox("Username is required.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                await setDoc(doc(db, "users", user.uid), {
                    username: username,
                    email: user.email,
                });

            } catch (error) {
                showMessageBox(`Error: ${error.message}`);
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                showMessageBox(`Error logging out: ${error.message}`);
            }
        }


        // --- SECTION HANDLING ---
        window.showSection = (sectionId) => {
            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
            const activeSection = document.getElementById(sectionId);
            if(activeSection) activeSection.classList.remove('hidden');

            if (sectionId === 'add-news-section' && !editingNewsId) {
                resetNewsForm();
            } else if (sectionId === 'profile-section') {
                loadProfileData();
            } else if (sectionId === 'home-section') {
                fetchNews('newsList');
            }
        }

        // --- CLOUDINARY LOGIC ---
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            
            const resourceType = file.type.startsWith('video') ? 'video' : 'image';
            const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('File upload failed.');
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error("Cloudinary upload error:", error);
                showMessageBox("Could not upload the file. Please try again.");
                return null;
            }
        }

        // --- NEWS LOGIC (Firestore CRUD) ---
        const addNewsForm = document.getElementById('addNewsForm');
        addNewsForm.addEventListener('submit', addOrUpdateNews);

        async function fetchUserProfile(uid) {
            if (usersCache.has(uid)) return usersCache.get(uid);
            try {
                const userDoc = await getDoc(doc(db, "users", uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    usersCache.set(uid, userData);
                    return userData;
                }
                return { username: 'Unknown Author' };
            } catch (error) {
                console.error("Error fetching user profile: ", error);
                return { username: 'Unknown Author' };
            }
        }

        async function fetchNews(elementId) {
            const listElement = document.getElementById(elementId);
            if (!listElement) return;
            listElement.innerHTML = '<p class="text-gray-500 col-span-full text-center">Loading news...</p>';

            let newsQuery;
            if (elementId === 'myNewsList') {
                newsQuery = query(collection(db, "news"), where("authorId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            } else {
                newsQuery = query(collection(db, "news"), orderBy("createdAt", "desc"));
            }

            onSnapshot(newsQuery, async (querySnapshot) => {
                const newsPromises = querySnapshot.docs.map(async (docSnap) => {
                    const newsItem = { id: docSnap.id, ...docSnap.data() };
                    const authorProfile = await fetchUserProfile(newsItem.authorId);
                    newsItem.authorName = authorProfile?.username;
                    newsItem.likeCount = docSnap.data().likeCount || 0;
                    newsItem.likes = docSnap.data().likes || [];
                    return newsItem;
                });

                const newsData = await Promise.all(newsPromises);
                renderNews(newsData, elementId);

            }, (error) => {
                console.error("Error listening to news collection: ", error);
                listElement.innerHTML = '<p class="text-red-500 col-span-full text-center">Could not load news.</p>';
            });
        }
        
        function renderNews(newsArray, elementId) {
            const listElement = document.getElementById(elementId);
            listElement.innerHTML = '';
            if (newsArray.length === 0) {
                listElement.innerHTML = '<p class="text-gray-500 col-span-full text-center">No news to display.</p>';
                return;
            }
            newsArray.forEach(news => {
                const card = createNewsCard(news);
                listElement.appendChild(card);
            });
        }

        function createNewsCard(news) {
            const card = document.createElement('div');
            card.className = 'card bg-white p-4 sm:p-6 rounded-xl shadow-lg flex flex-col justify-between';
            
            const isLikedByCurrentUser = news.likes && news.likes.includes(currentUser.uid);
            const likeIconClass = isLikedByCurrentUser ? 'fas fa-heart text-red-500' : 'far fa-heart';
            
            const buttonsHtml = (currentUser && currentUser.uid === news.authorId) ? `
                <button onclick="window.editNews('${news.id}')" class="btn btn-secondary text-blue-600 hover:text-blue-800" title="Edit"><i class="fas fa-edit"></i></button>
                <button onclick="window.removeNews('${news.id}')" class="btn btn-secondary text-red-600 hover:text-red-800" title="Delete"><i class="fas fa-trash-alt"></i></button>
            ` : '';

            const mediaHtml = news.mediaUrl ? (news.mediaType?.startsWith('video') ? `<video src="${news.mediaUrl}" controls class="news-media"></video>` : `<img src="${news.mediaUrl}" alt="${news.title}" class="news-media">`) : '';

            card.innerHTML = `
                <div>
                    ${mediaHtml}
                    <h3 class="text-xl font-semibold mb-2">${news.title}</h3>
                    <p class="text-gray-700 text-sm mb-3 whitespace-pre-wrap">${news.content}</p>
                    <p class="text-gray-500 text-xs">By: ${news.authorName} - ${news.createdAt?.toDate().toLocaleDateString() || 'Date not available'}</p>
                </div>
                
                <div class="mt-4 pt-4 border-t">
                    <div class="flex items-center justify-between">
                        <button onclick="window.toggleLike('${news.id}')" class="btn btn-secondary">
                            <i class="${likeIconClass} mr-2"></i> ${news.likeCount || 0} Likes
                        </button>
                        <div class="flex space-x-2">${buttonsHtml}</div>
                    </div>

                    <div id="comments-${news.id}" class="mt-4 space-y-2"></div>

                    <form id="comment-form-${news.id}" class="mt-4 flex space-x-2">
                        <input type="text" class="flex-grow !m-0" placeholder="Add a comment..." required>
                        <button type="submit" class="btn btn-primary">Post</button>
                    </form>
                </div>
            `;

            const commentForm = card.querySelector(`#comment-form-${news.id}`);
            commentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const input = commentForm.querySelector('input');
                const commentText = input.value.trim();
                if (commentText) {
                    window.addComment(news.id, commentText);
                    input.value = '';
                }
            });

            loadComments(news.id, card.querySelector(`#comments-${news.id}`));

            return card;
        }

        window.toggleLike = async (newsId) => {
            if (!currentUser) return;
            const newsRef = doc(db, "news", newsId);
            const newsDoc = await getDoc(newsRef);

            if (newsDoc.exists()) {
                const likes = newsDoc.data().likes || [];
                if (likes.includes(currentUser.uid)) {
                    await updateDoc(newsRef, {
                        likes: arrayRemove(currentUser.uid),
                        likeCount: (likes.length - 1) < 0 ? 0 : (likes.length - 1)
                    });
                } else {
                    await updateDoc(newsRef, {
                        likes: arrayUnion(currentUser.uid),
                        likeCount: (likes.length + 1)
                    });
                }
            }
        };

        window.addComment = async (newsId, text) => {
            if (!currentUser) return;
            try {
                const userProfile = await fetchUserProfile(currentUser.uid);
                await addDoc(collection(db, "news", newsId, "comments"), {
                    text: text,
                    authorId: currentUser.uid,
                    authorName: userProfile.username,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error adding comment: ", error);
                showMessageBox("Could not post comment.");
            }
        };

        function loadComments(newsId, container) {
            const commentsQuery = query(collection(db, "news", newsId, "comments"), orderBy("createdAt", "asc"));
            onSnapshot(commentsQuery, (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-xs">No comments yet.</p>';
                } else {
                    snapshot.forEach(docSnap => {
                        const comment = docSnap.data();
                        const commentEl = document.createElement('div');
                        commentEl.className = "text-sm bg-gray-100 p-2 rounded-md flex items-center justify-between";

                        const commentContent = document.createElement('span');
                        commentContent.innerHTML = `<strong class="font-semibold">${comment.authorName}</strong>: <span class="text-gray-700">${comment.text}</span>`;
                        commentEl.appendChild(commentContent);

                        if (currentUser && currentUser.uid === comment.authorId) {
                            const deleteButton = document.createElement('button');
                            deleteButton.className = "text-gray-400 hover:text-red-600 ml-4 focus:outline-none";
                            deleteButton.innerHTML = `<i class="fas fa-trash-alt"></i>`;
                            deleteButton.title = "Delete comment";
                            deleteButton.onclick = () => window.deleteComment(newsId, docSnap.id);
                            commentEl.appendChild(deleteButton);
                        }
                        
                        container.appendChild(commentEl);
                    });
                }
            });
        }
        
        window.deleteComment = (newsId, commentId) => {
            showMessageBox('Are you sure you want to delete this comment?', 'confirm', async () => {
                try {
                    const commentRef = doc(db, "news", newsId, "comments", commentId);
                    await deleteDoc(commentRef);
                } catch (error) {
                    console.error("Error deleting comment: ", error);
                    showMessageBox("Could not delete the comment.");
                }
            });
        };


        async function addOrUpdateNews(e) {
            e.preventDefault();
            if (!currentUser) return;

            const title = document.getElementById('newsTitle').value.trim();
            const content = document.getElementById('newsContent').value.trim();
            const mediaFile = document.getElementById('newsMediaFile').files[0];
            const submitBtn = document.getElementById('addNewsSubmitBtn');

            if (!title || !content) {
                showMessageBox("Title and content are required.");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Publishing...';

            try {
                const newsData = { title, content, authorId: currentUser.uid };

                if (mediaFile) {
                    const mediaUrl = await uploadToCloudinary(mediaFile);
                    if (!mediaUrl) return; 
                    newsData.mediaUrl = mediaUrl;
                    newsData.mediaType = mediaFile.type;
                }
                
                if (editingNewsId) {
                    const newsRef = doc(db, "news", editingNewsId);
                    await updateDoc(newsRef, newsData);
                    showMessageBox("News updated successfully.");
                } else {
                    newsData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "news"), newsData);
                    showMessageBox("News published successfully.");
                }
                
                resetNewsForm();
                showSection('home-section');

            } catch (error) {
                console.error("Error publishing news:", error);
                showMessageBox("Could not publish the news.");
            } finally {
                 submitBtn.disabled = false;
                 submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Publish News';
            }
        }

        window.editNews = async (id) => {
            try {
                const newsRef = doc(db, "news", id);
                const docSnap = await getDoc(newsRef);

                if (docSnap.exists() && docSnap.data().authorId === currentUser.uid) {
                    const news = docSnap.data();
                    editingNewsId = id;
                    document.getElementById('newsTitle').value = news.title;
                    document.getElementById('newsContent').value = news.content;
                    
                    document.getElementById('addNewsSectionTitle').innerText = 'Edit News';
                    document.getElementById('addNewsSubmitBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Update News';
                    document.getElementById('cancelEditBtn').classList.remove('hidden');
                    
                    showSection('add-news-section');
                } else {
                    showMessageBox("News not found or you do not have permission to edit it.");
                }
            } catch (error) {
                 showMessageBox("Error loading news for editing.");
            }
        };

        window.removeNews = (id) => {
             showMessageBox('Are you sure you want to delete this news?', 'confirm', async () => {
                try {
                    await deleteDoc(doc(db, "news", id));
                    showMessageBox("News deleted.");
                    // The real-time listener will automatically update the UI, no need to call fetchNews()
                } catch (error) {
                    showMessageBox("Error deleting news.");
                }
            });
        };

        window.cancelEdit = () => {
            resetNewsForm();
            showSection('home-section');
        }

        function resetNewsForm() {
            editingNewsId = null;
            addNewsForm.reset();
            document.getElementById('addNewsSectionTitle').innerText = 'Publish New News';
            document.getElementById('addNewsSubmitBtn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Publish News';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        // --- PROFILE LOGIC ---
        async function loadProfileData() {
            if(!currentUser) return;
            const userProfile = await fetchUserProfile(currentUser.uid);
            document.getElementById('profileUsername').value = userProfile?.username || '';
            document.getElementById('profile-email-display').innerText = currentUser.email;
            fetchNews('myNewsList');
        }

        document.getElementById('profileEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = document.getElementById('profileUsername').value.trim();
            if (!newUsername) {
                showMessageBox("Username cannot be empty.");
                return;
            }
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { username: newUsername });
                showMessageBox("Profile updated successfully.");
                usersCache.delete(currentUser.uid); // Clear cache to fetch new name
            } catch (error) {
                showMessageBox("Error updating profile.");
            }
        });

        // --- UTILITIES ---
        function showMessageBox(message, type = 'alert', callback = null) {
            const messageBox = document.getElementById('messageBox');
            const messageContent = document.getElementById('messageContent');
            const messageButtons = document.getElementById('messageButtons');
            messageContent.innerHTML = message;
            messageButtons.innerHTML = '';

            if (type === 'confirm') {
                const yesButton = document.createElement('button');
                yesButton.innerText = 'Yes';
                yesButton.className = 'btn-primary';
                yesButton.onclick = () => { if (callback) callback(); hideMessageBox(); };
                messageButtons.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.innerText = 'No';
                noButton.className = 'btn-secondary';
                noButton.onclick = hideMessageBox;
                messageButtons.appendChild(noButton);
            } else {
                const okButton = document.createElement('button');
                okButton.innerText = 'OK';
                okButton.className = 'btn-primary';
                okButton.onclick = hideMessageBox;
                messageButtons.appendChild(okButton);
            }
            messageBox.classList.remove('hidden');
        }
        function hideMessageBox() {
            document.getElementById('messageBox').classList.add('hidden');
        }

    </script>
</body>
</html>


